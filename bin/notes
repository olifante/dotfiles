#!/usr/bin/env ruby

# Command line tool to grep annotations from source files.
# Author:: Vivien 'v0n' Didelot <vivien.didelot@gmail.com>

# Useless, but informs that rak should be installed.
require 'rubygems'
require 'rak'

require 'rainbow'
require 'optparse'

NOTES_VERSION = "0.1"

TAGS = ["TODO", "FIXME", "IMPROVE"]

def find(tags, target)
  cmd = "rak " << "\'#{tags * "|"}\' " << target * " "
  out = `#{cmd}`.strip
  raise out if $?.exitstatus > 0

  out.split("\n").map do |l|
    # FIXME Ruby versions problem. Not always the same output. Try:
    # rvm ruby -e '`rak TODO`.split("\n").each { |l| puts l }'
    # if l =~ /^(.*):(\d*):.*(#{tags * "|"})\s*(.*)$/
    if l =~ /^([^\s]+)\s+(\d+)\|.*(#{tags * "|"})\s*(.*)$/
      { :file => $1, :line => $2.to_i, :tag => $3, :text => $4.strip }
    else
      # Just for a debug purpose
      raise "notes: does not match regexp => \"#{l}\""
    end
  end
end

def write(arr, file)
  longest_tag = arr.max { |a, b| a[:tag].size <=> b[:tag].size }[:tag].size

  File.open(file, 'w') do |f|
    arr.each do |a|
      f.write(sprintf(" * [%-#{longest_tag}s] %s (%s): %s\n", a[:tag], a[:file], a[:line], a[:text]))
    end
  end
end

def display(arr)
  arr.each do |a|
    tag = case a[:tag]
          when "TODO" then a[:tag].color(:yellow)
          when "FIXME" then a[:tag].color(:red)
          when "IMPROVE" then a[:tag].color(:green)
          else a[:tag].color(:blue)
          end

    printf("%s:%s: %s: %s\n", a[:file].color(:magenta), a[:line], tag, a[:text])
  end
end

tags = []
target = []
file = nil

ARGV.options do |o|
  o.banner = "Usage: #{File.basename $0} [options] [file...]\n"
  o.banner << "Search recursively for annotations in source code.\n"
  o.banner << "By default, #{File.basename $0} will search for all annotations in current directory.\n"

  o.on_head("Available options:")
  o.on("-a", "--all",                "Search TODO, FIXME and IMPROVE annotations") { tags << TAGS }
  o.on("-t", "--todo",               "Search TODO annotations")                    { tags << "TODO" }
  o.on("-f", "--fixme",              "Search FIXME annotations")                   { tags << "FIXME" }
  o.on("-i", "--improve",            "Search IMPROVE annotations")                 { tags << "IMPROVE" }
  o.on("-c", "--custom=TAG", String, "Search TAG annotations")                     { |v| tags << v }
  o.on("-o", "--out=FILE",   String, "Save output in FILE")                        { |v| file = v }
  o.on("-v", "--version",            "Print notes version")                        { puts "notes: version #{NOTES_VERSION}" ; exit }

  o.on_tail("Example: #{File.basename $0} -ac CODEME test.c lib\nwill search for TODO, FIXME, IMPROVE and CODEME annotations in test.c lib directory.")
end

begin
  ARGV.options.parse!
  tags = tags.empty? ? TAGS : tags.flatten
  target = ARGV
  arr = find(tags, target)
  file.nil? ? display(arr) : write(arr, file)
rescue => e
  STDERR.puts "error: #{e}"
end

exit
